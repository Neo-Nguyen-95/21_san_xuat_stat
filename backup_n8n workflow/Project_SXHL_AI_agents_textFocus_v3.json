{
  "name": "Project SXHL_AI agents_textFocus_v3",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -2540,
        -1320
      ],
      "id": "304a2222-534a-413b-94c6-f348aa4ae533",
      "name": "When clicking ‘Test workflow’"
    },
    {
      "parameters": {
        "content": "## Read & Split Text -> Smaller text\n",
        "height": 420,
        "width": 1920
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -2600,
        -1380
      ],
      "id": "e2b11a28-9722-4a01-90a1-a41e7a21a925",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "## VERSION 2"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2920,
        -1360
      ],
      "typeVersion": 1,
      "id": "b9d889fc-4955-46c5-9a26-ecbe88feacfc",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -1600,
        -1320
      ],
      "id": "1f9b1aa4-cf4b-4ff3-9fba-942717bad056",
      "name": "Loop Over Items",
      "executeOnce": false
    },
    {
      "parameters": {
        "jsCode": "\nfunction splitMarkdownByCauPattern(content) {\n  \n    // Regex pattern: \"Câu\" + any chars (non-greedy) + number + \".\"\n    const pattern = /(C[aâă]u?.*?\\d+\\.)/g;\n    // Split while keeping the delimiter using capturing groups\n    const parts = content.split(pattern);\n\n    const result = [];\n    // parts[0] is preamble (may be empty); parts[1] is first match, parts[2] is after, etc.\n    for (let i = 1; i < parts.length; i += 2) {\n        // Concatenate match + following text\n        const block = (parts[i] || '') + (parts[i + 1] || '');\n        result.push(block.trim());\n    }\n    return result;\n}\n\n// Example usage in n8n Code node:\nconst content = $('Extract text').first().json.data;\nconst blocks = splitMarkdownByCauPattern(content);\nconst filteredBlocks = blocks.filter(block => block.includes('$'));\nreturn filteredBlocks.map((block, idx) => ({ json: { index: idx+1, block } }));\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -840,
        -1300
      ],
      "id": "99ae3a1a-ee00-499b-ba02-1189b9726541",
      "name": "Split items"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.type }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "4e67b558-6808-4592-b497-b07c856a3b61"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "SA"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ca3fb66f-0e39-4cb0-a378-78eeda4cb420",
                    "leftValue": "={{ $json.type }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "MC"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "51b0fe38-b447-493a-a63c-8679dd3fea7c",
                    "leftValue": "={{ $json.type }}",
                    "rightValue": "18",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "TF"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        600,
        -1300
      ],
      "id": "1b708099-e874-4e35-bc5a-b861a27d5489",
      "name": "Switch"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{ \n\"hint\": \"gợi ý làm bài\", \n\"solution\": \"lời giải chi tiết\",\n\"answer_key\": \"index của đáp án từ 0 tới 3. A B C D tương ứng với 0 1 2 3\",\n\"muc_do\": \"1, 2, hoặc 3\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        1060,
        -1380
      ],
      "id": "a55a5ba9-e39b-4c40-ac99-62dd79398690",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "resource": "fileFolder",
        "returnAll": true,
        "filter": {
          "folderId": {
            "__rl": true,
            "value": "1eOlKXlulSUgYkatBDl8J-yBYlBqtHka3",
            "mode": "list",
            "cachedResultName": "on-luyen-tn-thi-thpt",
            "cachedResultUrl": "https://drive.google.com/drive/folders/1eOlKXlulSUgYkatBDl8J-yBYlBqtHka3"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -2040,
        -1220
      ],
      "id": "85023943-2fb6-471e-9563-4db11a358ba9",
      "name": "Search Files",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "sl3WAqlpDET9I5p9",
          "name": "AE Gg Drive acc"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -1820,
        -1220
      ],
      "id": "262816b1-fc3c-46a9-9365-21fd129295cb",
      "name": "Download Files",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "sl3WAqlpDET9I5p9",
          "name": "AE Gg Drive acc"
        }
      }
    },
    {
      "parameters": {
        "operation": "text",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -1300,
        -1300
      ],
      "id": "2dcd51c5-3dad-4053-b349-d401ca1d156d",
      "name": "Extract text"
    },
    {
      "parameters": {
        "fileSelector": "/Users/dungnguyen/Desktop/Experiment folder/demo on-luyen-tn-thi-thpt/*",
        "options": {}
      },
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [
        -1960,
        -1440
      ],
      "id": "389983cf-fda5-460b-9f39-35a5ce3ce65b",
      "name": "Read Files from Disk"
    },
    {
      "parameters": {
        "jsCode": "function classify(text = '') {\n  const mc = (text.match(/(^|\\n)\\s*[A-D]\\s*[\\.\\):]/g) || []).length;\n  const tf = (text.match(/(^|\\n)\\s*[a-d]\\s*\\)/g) || []).length;\n\n  if (mc >= 3 && mc > tf) return 2; // MC wins\n  if (tf >= 3) return 18;   // TF\n  return 1; // SA\n}\n\nconst items = $input.all();\n\nreturn items.map(item => {\n  const content = item.json.block;\n  const type = classify(String(content));\n  \n  let augmented = content.replace(/^Câu\\s+\\d+\\.\\s*/i, '');\n  \n  if (type == 1) {augmented = augmented + ' Đáp án: __key__'}\n  \n  \n  return { json: { \n    item: augmented , \n    type\n  } };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60,
        -1280
      ],
      "id": "36f88fb9-9cb3-4b5b-b80d-de611895a542",
      "name": "Type classifier v2"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Giải bài tập sau:\n{{ $('Switch').item.json.item }}\n\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=# BỐI CẢNH #\nBạn là một giáo viên môn Toán cấp trung học phổ thông.\n\n# NHIỆM VỤ #\nBước 1: Đưa ra gợi ý làm bài. \nGợi ý làm bài cần ngắn gọn, súc tích, và bắt đầu bằng một động từ. Nếu có công thức, định lí, định nghĩa nào cần được áp dụng thì phải nêu tên, không cần nêu nội dung chi tiết\nBước 2: Đưa ra lời giải chi tiết dựa trên gợi ý làm bài.\nBước 3: Đưa index của đáp án\nBước 4: đánh giá mức độ câu hỏi\n\n# Trả về dạng JSON:\n{ \n\"hint\": \"gợi ý làm bài\", \n\"solution\": \"lời giải chi tiết, phép tính dạng LaTeX chèn trong dấu $\",\n\"answer_key\": \"index của đáp án từ 0 tới 3. A B C D tương ứng với 0 1 2 3\",\n\"muc_do\": \"1 (dễ), 2 (trung bình), hoặc 3 (khó)\"\n}\n\n# Lưu ý\nViết công thức, phép tính bằng LaTeX chèn trong dấu $, không dùng $$, không dùng \\n. Nếu có phân số thì dùng \\dfrac{}{}. Trong Tiếng Việt, ngăn cách của phần nghìn là dấu cách. Ví dụ: 2000 = 2 000, 2000 không bằng 2,000.\n\n",
          "returnIntermediateSteps": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        900,
        -1560
      ],
      "id": "c55190de-892e-4c22-8027-7833bab525ff",
      "name": "MC solver",
      "retryOnFail": true,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\"question\": \"Tập xác định của hàm số $y = \\\\frac{1}{x - 2}$ là:\",\n\"options\": [\"$x > 2$\", \"$x ≠ 2$\", \"$x < 2$\", \"$x = 2$\"]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        1040,
        -1040
      ],
      "id": "854d5768-5cb0-45d7-b964-a2205a2747ca",
      "name": "Structured Output Parser1"
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        1980,
        -1300
      ],
      "id": "6f19f247-ae18-4ff9-8235-5e62dacbb63b",
      "name": "Merge"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://steve-api.lotuslms.com/question-bank/editor/fetch-node",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "iid",
              "value": "={{ $('Item Infor').first().json.bank_iid }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:138.0) Gecko/20100101 Firefox/138.0"
            },
            {
              "name": "Accept",
              "value": "application/json, text/plain, */*"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.5"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br, zstd"
            },
            {
              "name": "Referer",
              "value": "https://aeglobal.lotuslms.com/admin/content-manager/folder/65f9342205fa1dc3dc014480"
            },
            {
              "name": "Origin",
              "value": "https://aeglobal.lotuslms.com"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Sec-Fetch-Dest",
              "value": "empty"
            },
            {
              "name": "Sec-Fetch-Mode",
              "value": "cors"
            },
            {
              "name": "Sec-Fetch-Site",
              "value": "same-site"
            },
            {
              "name": "Priority",
              "value": "u=0"
            },
            {
              "name": "Cookie",
              "value": "name=value; name=value"
            },
            {
              "name": "cookie",
              "value": "name=value;"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "_sand_token",
              "value": "={{ $('Login Info').first().json.token }}"
            },
            {
              "name": "_sand_uiid",
              "value": "={{ $('Login Info').first().json.uid }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2720,
        -1300
      ],
      "id": "c6947d9e-f79a-42d4-a528-d672cb2474b0",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5c286b29-5ff2-4538-ae03-4f286ce3c19d",
              "name": "token",
              "value": "={{ $(\"Login\").first().json.result.token }}",
              "type": "string"
            },
            {
              "id": "7cbb922f-6bf8-45ea-b333-cc9ae2bd82ce",
              "name": "uid",
              "value": "={{ $(\"Login\").first().json.result.iid }}",
              "type": "string"
            },
            {
              "id": "4296ec2a-1d5b-4a9e-a27e-5b97c5f8735c",
              "name": "",
              "value": "",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2460,
        -1300
      ],
      "id": "010c995c-6415-4ccd-b042-755fee2c2b3a",
      "name": "Login Info"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://steve-api.lotuslms.com/user/login",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:138.0) Gecko/20100101 Firefox/138.0"
            },
            {
              "name": "Accept",
              "value": "application/json, text/plain, */*"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.5"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br, zstd"
            },
            {
              "name": "Referer",
              "value": "https://aeglobal.lotuslms.com/user/login/?logout=1"
            },
            {
              "name": "Origin",
              "value": "https://aeglobal.lotuslms.com"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Sec-Fetch-Dest",
              "value": "empty"
            },
            {
              "name": "Sec-Fetch-Mode",
              "value": "cors"
            },
            {
              "name": "Sec-Fetch-Site",
              "value": "same-site"
            },
            {
              "name": "Priority",
              "value": "u=0"
            },
            {
              "name": "Cookie",
              "value": "name=value"
            },
            {
              "name": "cookie",
              "value": "name=value;"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "lname",
              "value": "aeglobal"
            },
            {
              "name": "pass",
              "value": "123"
            },
            {
              "name": "submit",
              "value": "1"
            },
            {
              "name": "_sand_domain",
              "value": "aeglobal"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2320,
        -1320
      ],
      "id": "8fc72e72-265c-4d9d-aded-067f678a989a",
      "name": "Login"
    },
    {
      "parameters": {
        "jsCode": "function jsonToKeyValuePairs(data) {\n  const result = {};\n\n  function walk(obj, path = []) {\n    if (Array.isArray(obj)) {\n      for (let i = 0; i < obj.length; i++) {\n        walk(obj[i], [...path, i]);\n      }\n    } else if (typeof obj === 'object' && obj !== null) {\n      Object.keys(obj).forEach(key => {\n        walk(obj[key], [...path, key]);\n      });\n    } else {\n      // Chỉ thêm [ ] cho các phần tử sau phần tử đầu tiên\n      const rootKey = path[0];              // Ví dụ: questions\n      const restKeys = path.slice(1);       // Ví dụ: [0, 'content']\n\n      let finalKey = rootKey;\n\n      if (restKeys.length > 0) {\n        finalKey += '[' + restKeys.join('][') + ']';\n      }\n\n      result[finalKey] = obj === null ? '' : obj.toString();\n    }\n  }\n\n  walk(data);\n  return result;\n}\n\nlet questionsData = $('Question array').first().json;\n\nlet questions = jsonToKeyValuePairs(questionsData);\nconsole.log(questions)\n\nconst request_options = {\n  url: 'https://steve-api.lotuslms.com/exercise/editor/add-questions ',\n  method: 'POST',\n  body: {\n    ...questions,\n    \"exerciseIid\": $input.first().json.result.exercise_iid,\n    \"rootNode[iid]\": $('Item Infor').first().json.bank_iid,\n    \"rootNode[ntype]\": \"question-bank\",\n    \"fileId\": (new Date()).toTimeString(),\n    \"_sand_domain\": \"aeglobal\",\n    \"_sand_token\": $('Login Info').first().json.token,\n    \"_sand_uiid\": $('Login Info').first().json.uid\n  },\n  headers: {\n    \"User-Agent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:138.0) Gecko/20100101 Firefox/138.0\",\n    \"Accept\": \"application/json, text/plain, */*\",\n    \"Accept-Language\": \"en-US,en;q=0.5\",\n    \"Accept-Encoding\": \"gzip, deflate, br, zstd\",\n    \"Referer\": \"https://aeglobal.lotuslms.com/admin/content-manager/folder/65f9342205fa1dc3dc014480 \",\n    \"Origin\": \"https://aeglobal.lotuslms.com \",\n    \"Connection\": \"keep-alive\",\n    \"Sec-Fetch-Dest\": \"empty\",\n    \"Sec-Fetch-Mode\": \"cors\",\n    \"Sec-Fetch-Site\": \"same-site\",\n    \"Cookie\": \"name=value; name=value\",\n    \"Content-Type\": \"multipart/form-data\"\n  }\n};\n\nconst response = await this.helpers.httpRequest(request_options);\n\nreturn [{\n  json: {\n    response_data: response\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3040,
        -1300
      ],
      "id": "c99eb714-000c-4899-aff3-56014c8472cc",
      "name": "Code6"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://steve-api.lotuslms.com/question-bank/editor/move-exercise-questions-to-bank",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json, text/plain, */*"
            },
            {
              "name": "Accept-Language",
              "value": "en-US,en;q=0.5"
            },
            {
              "name": "Accept-Encoding",
              "value": "gzip, deflate, br, zstd"
            },
            {
              "name": "Referer",
              "value": "https://aeglobal.lotuslms.com/admin/content-manager/folder/682d4914d8ce0f395e0144c8"
            },
            {
              "name": "Origin",
              "value": "https://aeglobal.lotuslms.com"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            },
            {
              "name": "Sec-Fetch-Dest",
              "value": "empty"
            },
            {
              "name": "Sec-Fetch-Mode",
              "value": "cors"
            },
            {
              "name": "Sec-Fetch-Site",
              "value": "same-site"
            },
            {
              "name": "Priority",
              "value": "u=0"
            },
            {
              "name": "Cookie",
              "value": "name=value; name=value"
            },
            {
              "name": "cookie",
              "value": "name=value;"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "iid",
              "value": "={{ $('Item Infor').first().json.bank_iid }}"
            },
            {
              "name": "submit",
              "value": "1"
            },
            {
              "name": "_sand_domain",
              "value": "aeglobal"
            },
            {
              "name": "_sand_token",
              "value": "={{ $('Login Info').item.json.token }}"
            },
            {
              "name": "_sand_uiid",
              "value": "={{ $('Login Info').item.json.uid }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3100,
        -160
      ],
      "id": "176193f0-695e-4682-b8e6-f4e016551c09",
      "name": "HTTP Request4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Chuyển câu hỏi sau thành dạng như thiết lập:\n {{ $json.item }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "Bạn là một trợ lý thông minh chuyên xử lý nội dung Toán. Hãy đọc kỹ đoạn văn hoặc danh sách câu hỏi được cung cấp và chuyển đổi toàn bộ thành một mảng JSON. Không thay đổi nội dung câu hỏi, chỉ thích ứng với format cài đặt trước, chỉ sửa lỗi chính tả nếu có.\n\nKết quả trả về dạng JSON như ví dụ sau:\n{\"question\": \"Tập xác định của hàm số $y = \\\\frac{1}{x - 2}$ là:\",\n\"options\": [\"$x > 2$\", \"$x ≠ 2$\", \"$x < 2$\", \"$x = 2$\"]\n}"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        880,
        -1220
      ],
      "id": "0625d6be-121b-40c1-856b-cd82454ae445",
      "name": "MC extractor",
      "retryOnFail": true,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "jsCode": "/*  Get the correct answer index (cast to Number for safety) */\n\n/* Iterate over current node input */\nreturn $input.all().map(item => {\n  const correctIndex = Number(item.json.output.answer_key ?? 0);\n\n  /* 3️⃣  Build the answers array, all flagged 0 first */\n  const answers = (item.json.output.options || []).map(opt => ({\n    text: opt,\n    is_answer: 0,\n  }));\n\n  /* 4️⃣  Flip the is_answer bit at correctIndex */\n  if (answers[correctIndex]) answers[correctIndex].is_answer = 1;   // .forEach not needed\n\n  /* 5️⃣  Compose the final question object */\n  const question = {\n    type: 2,          // e.g. 2 for multiple-choice\n    content: item.json.output.question,\n    answers,                               // array built above\n    tpl_type: \"mc_answer_text\",\n    difficulty: item.json.output.muc_do,\n    hints: [\n      { name: item.json.output.hint},\n      { name: item.json.output.solution},\n    ],\n    shufflable: 0,\n    tags: [$('Item Infor').first().json.source]\n  };\n\n  /* 6️⃣  Return an item that matches your schema */\n  return {\n    json: {question},\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1580,
        -1440
      ],
      "id": "f4ed5cc8-1e97-429e-82c3-7f9861484e5c",
      "name": "LMS MC parser"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n\"question\": \"Tính giá trị của biểu thức $A = 2x + 3$ khi $x = 4$. Giá trị của biểu thức là __key__\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        1040,
        -1720
      ],
      "id": "05bbfb08-c10a-440a-bbbc-ef4444e7f451",
      "name": "Structured Output Parser3"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Chuyển câu hỏi sau thành dạng như thiết lập:\n {{ $json.item }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "Bạn là một trợ lý thông minh chuyên xử lý nội dung Toán. Hãy đọc kỹ đoạn văn hoặc danh sách câu hỏi được cung cấp và chuyển đổi toàn bộ thành một mảng JSON. Không thay đổi nội dung câu hỏi, chỉ sửa lỗi chính tả nếu có, thích ứng với format cài đặt trước.\n\nKết quả trả về dạng JSON như ví dụ sau:\n{\n\"question\": \"Tính giá trị của biểu thức $A = 2x + 3$ khi $x = 4$. Giá trị của biểu thức là __key__\",\n}"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        880,
        -1900
      ],
      "id": "bb3ff1ca-e8b4-465c-bb30-1cacbc886556",
      "name": "SA extractor",
      "retryOnFail": true,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "openai/gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "openai/gpt-4.1-mini"
        },
        "options": {
          "responseFormat": "json_object"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        300,
        -780
      ],
      "id": "de27b6c5-a81b-4cbd-ba65-506b18003fc1",
      "name": "OpenAI Chat Model4",
      "credentials": {
        "openAiApi": {
          "id": "X0Oj8gltDW0jubgn",
          "name": "OpenRouter AE"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{ \n\"hint\": \"gợi ý làm bài\", \n\"solution\": \"lời giải chi tiết\",\n\"answers\": \"đáp án cần điền\",\n\"muc_do\": \"1, 2, hoặc 3\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        1040,
        -2040
      ],
      "id": "4943677a-3a6b-4bdf-bbf5-9986f4e57604",
      "name": "Structured Output Parser4"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Giải bài tập sau:\n{{ $('Switch').item.json.item }}\n\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=# BỐI CẢNH #\nBạn là một giáo viên môn Toán cấp trung học phổ thông.\n\n# NHIỆM VỤ #\nBước 1: Đưa ra gợi ý làm bài. \nGợi ý làm bài cần ngắn gọn, súc tích, và bắt đầu bằng một động từ. Nếu có công thức, định lí, định nghĩa nào cần được áp dụng thì phải nêu tên, không cần nêu nội dung chi tiết\nBước 2: Đưa ra lời giải chi tiết dựa trên gợi ý làm bài.\nBước 3: Đưa index của đáp án\nBước 4: đánh giá mức độ câu hỏi\n\n# Trả về dạng JSON:\n{ \n\"hint\": \"gợi ý làm bài\", \n\"solution\": \"lời giải chi tiết, viết công thức bằng LaTeX chèn trong dấu $, không sử dụng \\n\",\n\"answer\": \"đáp án cần điền\",\n\"muc_do\": \"1 (dễ), 2 (trung bình), hoặc 3 (khó)\"\n}\n\n# Lưu ý\nViết số, công thức, phép tính ở dạng Markdown, viết công thức bằng LaTeX chèn trong dấu $, không dùng $$, không dùng \\n. Nếu có phân số thì dùng \\dfrac{}{}. Trong Tiếng Việt, ngăn cách của phần nghìn là dấu cách. Ví dụ: 2000 = 2 000, 2000 không bằng 2,000.\n\n",
          "returnIntermediateSteps": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        880,
        -2240
      ],
      "id": "ca55a26f-f00e-4671-97d6-f2720cac3574",
      "name": "SA solver",
      "notesInFlow": false,
      "retryOnFail": true,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "jsCode": "return $input.all().map(item => {\n\n  const content   = item.json.output.question; \n  const adapted_content = content.replace(\"__key__\", `__${item.json.output.answers}__`)\n\n  const question = {\n      \"type\": 1,\n      \"content\": adapted_content,\n      \"answers\": [String(item.json.output.answers)],\n      \"difficulty\": item.json.output.muc_do,\n      \"hints\": [\n        {\n           \"name\": item.json.output.hint\n        },\n        {\n          \"name\": item.json.output.solution\n        }\n      ],\n    tags: [$('Item Infor').first().json.source]\n    };\n\n  return {\n    json: {question},\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1580,
        -1780
      ],
      "id": "173352dc-d683-4902-85db-981de4c32736",
      "name": "LMS SA parser"
    },
    {
      "parameters": {
        "jsCode": "const filename = $('Loop Over Items').first().json.fileName;\n\nconst grade = filename.split(\"_\")[0]\n\nconst source = filename.split(\"_\")[1]\n\n// take the last chunk after splitting by \"_\"\nconst lastChunk = filename.split(\"_\").pop();   // \"28545799.md\"\n// remove the extension (anything after the last dot)\nconst id = lastChunk.replace(/\\.[^.]+$/, \"\");  // \"28545799\"\n\nreturn {\n  grade,\n  source,\n  bank_iid: id\n} "
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1060,
        -1300
      ],
      "id": "56b0b425-9d32-4f87-b2df-72ff3bc6f175",
      "name": "Item Infor"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"statement\": \"Xét tính đúng sai của các phát biểu sau, cho biết $x + y = 4$\",\n  \"likert_questions\": [\n        {\"content\": \"$x + y < 3$\"},\n        {\"content\": \"$x.y = 5$\"},\n        {\"content\": \"$x^2 + y/2 < 5$\"}\n      ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        1020,
        -640
      ],
      "id": "5393d205-c3a3-41f4-9b5c-87ede6c61822",
      "name": "Structured Output Parser5"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Chuyển câu hỏi sau thành dạng như thiết lập:\n {{ $json.item }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "Bạn là một trợ lý thông minh chuyên xử lý nội dung Toán. Hãy đọc kỹ đoạn văn hoặc danh sách câu hỏi được cung cấp và chuyển đổi toàn bộ thành một mảng JSON. Không thay đổi nội dung câu hỏi, chỉ sửa lỗi chính tả nếu có, chỉ thích ứng với format cài đặt trước.\n\nKết quả trả về dạng JSON như ví dụ sau:\n{\n  \"statement\": \"Xét tính đúng sai của các phát biểu sau, cho biết $x + y = 4$\",\n  \"likert_questions\": [\n        {\"content\": \"$x + y < 3$\"},\n        {\"content\": \"$x.y = 5$\"},\n        {\"content\": \"$x^2 + y/2 < 5$\"}\n      ]\n}\n\nLưu ý: Viết công thức, phép tính ở dạng Markdown, viết công thức bằng LaTeX chèn trong dấu $."
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        860,
        -820
      ],
      "id": "15e28317-b911-471b-8010-6ccb2044ae65",
      "name": "TF extractor",
      "retryOnFail": true,
      "waitBetweenTries": 2000
    },
    {
      "parameters": {
        "jsonSchemaExample": "{ \n\"hint\": \"gợi ý làm bài\", \n\"solution\": \"lời giải chi tiết, xét tính đúng sai của từng khẳng định, phép tính LaTeX chèn trong dấu $\",\n\"answer_key\": \"[[0], [1], [0]]\",\n\"muc_do\": \"1 (dễ), 2 (trung bình), hoặc 3 (khó)\"\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        1000,
        -240
      ],
      "id": "52e49db6-e1f5-40c8-9a7c-9abcf525282d",
      "name": "Structured Output Parser6"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Giải bài tập sau:\n{{ $('Switch').item.json.item }}\n\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=# BỐI CẢNH #\nBạn là một giáo viên môn Toán cấp trung học phổ thông.\n\n# NHIỆM VỤ #\nBước 1: Đưa ra gợi ý làm bài. \nGợi ý làm bài cần ngắn gọn, súc tích, và bắt đầu bằng một động từ. Nếu có công thức, định lí, định nghĩa nào cần được áp dụng thì phải nêu tên, không cần nêu nội dung chi tiết\nBước 2: Đưa ra lời giải chi tiết dựa trên gợi ý làm bài.\nBước 3: Đưa index của đáp án\nBước 4: đánh giá mức độ câu hỏi\n\n# Trả về dạng JSON:\n{ \n\"hint\": \"gợi ý làm bài\", \n\"solution\": \"lời giải chi tiết, xét tính đúng sai của từng khẳng định, phép tính LaTeX chèn trong dấu $, không dùng \\n\",\n\"answer_key\": [[0 (nếu nhận định đúng)], [1 (nếu nhận định sai)], [0]],\n\"muc_do\": \"1 (dễ), 2 (trung bình), hoặc 3 (khó)\"\n}\n\n# Lưu ý\nViết công thức, phép tính ở dạng Markdown, viết công thức bằng LaTeX chèn trong dấu $, không dùng $$, không dùng \\n. Nếu có phân số thì dùng \\dfrac{}{}. Trong Tiếng Việt, ngăn cách của phần nghìn là dấu cách. Ví dụ: 2000 = 2 000, 2000 không bằng 2,000.\n\n",
          "returnIntermediateSteps": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        840,
        -460
      ],
      "id": "7c8ea30d-9dfd-411f-8c44-847d4480a215",
      "name": "TF solver",
      "retryOnFail": true,
      "waitBetweenTries": 3000,
      "maxTries": 5
    },
    {
      "parameters": {
        "jsCode": "/* Iterate over current node input */\nreturn $input.all().map(item => {\n  \n  const question = {\n      \"type\": 18,\n      \"content\": item.json.output.statement,\n      \"likert_answers\": [\n        {\n          \"content\": \"Đúng\",\n          \"id\": \"lkc1\"\n        },\n        {\n          \"content\": \"Sai\",\n          \"id\": \"lkc2\"\n        }\n      ],\n      \"likert_questions\": item.json.output.likert_questions,\n      \"likert_correct_answers\": JSON.parse(item.json.output.answer_key),\n      \"difficulty\": item.json.output.muc_do,\n      \"hints\": [\n        {\n          \"name\": item.json.output.hint\n        },\n        {\n          \"name\": item.json.output.solution\n        }\n      ],\n    tags: [$('Item Infor').first().json.source]\n    };\n\n  /*  Return an item that matches your schema */\n  return {\n    json: {question},\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1640,
        -900
      ],
      "id": "9aaa0b01-2243-4195-870f-e500379b2b54",
      "name": "LMS TF parser"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        1320,
        -2060
      ],
      "id": "d10e635a-4af6-411f-af68-fbd7b0187f2c",
      "name": "Merge1"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        1340,
        -1440
      ],
      "id": "6fb3fec7-8619-423e-afb3-300967d398f1",
      "name": "Merge2"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        1320,
        -700
      ],
      "id": "14609223-f3f8-4aec-be2f-13fb05d82bf0",
      "name": "Merge3"
    },
    {
      "parameters": {
        "jsCode": "const mergedArray = $input.all().map(i => i.json.question);  // => [ {...}, {...}, ... ]\nreturn [{\n  json: { questions: mergedArray }   // single item out\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2220,
        -1300
      ],
      "id": "dd541329-5b58-4f7e-b152-506dba681b53",
      "name": "Question array"
    },
    {
      "parameters": {
        "batchSize": 10,
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -440,
        -1300
      ],
      "id": "05cd495d-ebdf-4583-8361-3ad675062c57",
      "name": "Loop Over Items1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3140,
        220
      ],
      "id": "ec96909e-1d6c-4514-ad08-4bce78a92bf0",
      "name": "No Operation, do nothing1"
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking ‘Test workflow’": {
      "main": [
        [
          {
            "node": "Login",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Extract text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split items": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "SA extractor",
            "type": "main",
            "index": 0
          },
          {
            "node": "SA solver",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "MC extractor",
            "type": "main",
            "index": 0
          },
          {
            "node": "MC solver",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "TF extractor",
            "type": "main",
            "index": 0
          },
          {
            "node": "TF solver",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "MC solver",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Search Files": {
      "main": [
        [
          {
            "node": "Download Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Files": {
      "main": [
        []
      ]
    },
    "Extract text": {
      "main": [
        [
          {
            "node": "Item Infor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Files from Disk": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Type classifier v2": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "MC extractor",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "MC solver": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Question array",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Code6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Login Info": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Login": {
      "main": [
        [
          {
            "node": "Read Files from Disk",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code6": {
      "main": [
        [
          {
            "node": "HTTP Request4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BankData": {
      "main": [
        [
          {
            "node": "HTTP Request5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MC extractor": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "LMS MC parser": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Structured Output Parser3": {
      "ai_outputParser": [
        [
          {
            "node": "SA extractor",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "SA solver",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "SA extractor",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "MC solver",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "MC extractor",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "TF extractor",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "TF solver",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser4": {
      "ai_outputParser": [
        [
          {
            "node": "SA solver",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "SA extractor": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "SA solver": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LMS SA parser": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Item Infor": {
      "main": [
        [
          {
            "node": "Split items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser5": {
      "ai_outputParser": [
        [
          {
            "node": "TF extractor",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser6": {
      "ai_outputParser": [
        [
          {
            "node": "TF solver",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "TF extractor": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TF solver": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "LMS TF parser": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "HTTP Request4": {
      "main": [
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "LMS SA parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "LMS MC parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge3": {
      "main": [
        [
          {
            "node": "LMS TF parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Question array": {
      "main": [
        [
          {
            "node": "Login Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [],
        [
          {
            "node": "Type classifier v2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "3e8c014c-0795-4ec3-87c1-85228cde27f0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "861cdce3c56afff549db6b3bcaa434d956ea7f52bf2bb2c15080b9f278a79c1f"
  },
  "id": "0jmPr6rLo2Qntr7C",
  "tags": []
}